# Docker Compose file - version attribute removed (obsolete in newer versions)

services:
  backend:
    profiles: ["backtest", "both"]  # Backtest profile - current system runs here
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: odum-backend
    ports:
      - "8000:8000"
    volumes:
      # Mount backend code for development (changes reflected immediately)
      - ./backend:/app/backend
      # Conditional: only mount local data_downloads if not using FUSE
      # If USE_GCS_FUSE=true, gcsfuse will mount to /app/data_downloads
      - ./data_downloads:/app/data_downloads:ro
      - ./backend/data/parquet:/app/backend/data/parquet
      - ./backend/backtest_results:/app/backend/backtest_results
      - ./external/data_downloads/configs:/app/external/data_downloads/configs:ro
      - ./external/unified-cloud-services:/app/external/unified-cloud-services:ro
      - ./frontend/public/tickdata:/app/frontend/public/tickdata
      # Mount secrets directory for GCS authentication
      - ./.secrets:/app/.secrets:ro
    environment:
      # All variables read from .env file (docker-compose automatically loads .env)
      # SECURITY: Sensitive values (project IDs, bucket names) MUST be set in .env - no defaults
      # Format: ${VAR:-default} means use VAR from .env if set, otherwise use default
      # Format: ${VAR} means VAR is REQUIRED - application validates at startup (start.sh)
      # Note: Docker Compose sets empty string if VAR not found, but start.sh validates and fails fast
      
      # Non-sensitive configuration (safe defaults)
      - UNIFIED_CLOUD_LOCAL_PATH=${UNIFIED_CLOUD_LOCAL_PATH:-/app/data_downloads}
      - UNIFIED_CLOUD_SERVICES_USE_PARQUET=${UNIFIED_CLOUD_SERVICES_USE_PARQUET:-true}
      - UNIFIED_CLOUD_SERVICES_USE_DIRECT_GCS=${UNIFIED_CLOUD_SERVICES_USE_DIRECT_GCS:-true}
      - DATA_CATALOG_PATH=${DATA_CATALOG_PATH:-/app/backend/data/parquet}
      
      # REQUIRED: GCS credentials (path to service account JSON file)
      # Default path is OK as it's just a filesystem path, not sensitive data
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/.secrets/gcs/gcs-service-account.json}
      
      # REQUIRED: GCP Project ID (MUST be set in .env - no default for security)
      # This is sensitive infrastructure information - should not be hardcoded
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      
      # REQUIRED: GCS bucket for UCS (market data - input, MUST be set in .env)
      # Bucket names are sensitive infrastructure information
      - UNIFIED_CLOUD_SERVICES_GCS_BUCKET=${UNIFIED_CLOUD_SERVICES_GCS_BUCKET}
      
      # REQUIRED: GCS bucket for backtest results (output, MUST be set in .env)
      # Bucket names are sensitive infrastructure information
      - EXECUTION_STORE_GCS_BUCKET=${EXECUTION_STORE_GCS_BUCKET}
      
      # Optional: GCS FUSE configuration (safe defaults)
      - USE_GCS_FUSE=${USE_GCS_FUSE:-false}
      - GCS_FUSE_BUCKET=${GCS_FUSE_BUCKET:-}
      - GCS_SERVICE_ACCOUNT_KEY=${GCS_SERVICE_ACCOUNT_KEY:-}
    # Use start.sh which handles FUSE mounting
    command: bash /app/backend/scripts/start.sh
    # Note: Privileged mode is required for FUSE mounting
    # Set privileged: true in docker-compose.override.yml or manually when USE_GCS_FUSE=true
    # privileged: true  # Uncomment this line when using GCS FUSE
    networks:
      - backtest-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # Optional: Add restart policy for production
    # restart: unless-stopped
    # Optional: Add resource limits for production
    # deploy:
    #   resources:
    #     limits:
    #       memory: 2G
    #       cpus: '1.0'

  frontend:
    profiles: ["backtest", "live", "both"]  # Frontend works with all profiles
    build:
      context: .
      dockerfile: frontend/Dockerfile
    container_name: odum-frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - ./backend/backtest_results:/app/backend/backtest_results:ro
      - ./frontend/public/tickdata:/app/public/tickdata
      - ./external/data_downloads/configs:/app/external/data_downloads/configs:ro
    environment:
      - VITE_API_URL=http://localhost:8000  # Use localhost for browser access
      - VITE_BACKTEST_API_URL=http://backend:8000
      - VITE_LIVE_API_URL=http://live-backend:8001
      - DOCKER=true  # Flag to indicate running in Docker
      - BACKEND_PROXY_URL=http://backend:8000  # Backend service name for proxy
    networks:
      - backtest-network
    # Note: frontend works independently - can connect to backend or live-backend when available
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5173"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    # Optional: Add restart policy for production
    # restart: unless-stopped
    # Optional: Add resource limits for production
    # deploy:
    #   resources:
    #     limits:
    #       memory: 1G
    #       cpus: '0.5'

  redis:
    image: redis:7-alpine
    container_name: odum-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - backtest-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    profiles:
      - batch-processing
    # Optional: Add restart policy for production
    # restart: unless-stopped

  # Live Execution Service (port 8001) - NEW
  live-backend:
    profiles: ["live", "both"]
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: odum-live-backend
    ports:
      - "8001:8001"
    volumes:
      - ./backend:/app/backend
      - ./data_downloads:/app/data_downloads:ro
      - ./backend/data/parquet:/app/backend/data/parquet
      - ./external/data_downloads/configs:/app/external/data_downloads/configs:ro
      - ./external/unified-cloud-services:/app/external/unified-cloud-services:ro
      - ./.secrets:/app/.secrets:ro
    environment:
      - UNIFIED_CLOUD_LOCAL_PATH=/app/data_downloads
      - UNIFIED_CLOUD_SERVICES_USE_PARQUET=true
      - UNIFIED_CLOUD_SERVICES_USE_DIRECT_GCS=true
      - DATA_CATALOG_PATH=/app/backend/data/parquet
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/.secrets/gcs/gcs-service-account.json}
      - DATABASE_URL=postgresql://user:pass@postgres:5432/execution_db
      - REDIS_URL=redis://redis-live:6379/0
    command: uvicorn backend.api.live_server:app --host 0.0.0.0 --port 8001
    depends_on:
      - postgres
      - redis-live
    networks:
      - backtest-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL Database - NEW (Local Development Only)
  postgres:
    profiles: ["live", "both"]
    image: postgres:15
    container_name: odum-postgres
    environment:
      - POSTGRES_DB=execution_db
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    ports:
      - "54320:5432"  # Use 54320 externally to avoid conflict with local PostgreSQL
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - backtest-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d execution_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for Live Execution - NEW
  redis-live:
    profiles: ["live", "both"]
    image: redis:7-alpine
    container_name: odum-redis-live
    ports:
      - "6380:6379"
    networks:
      - backtest-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  redis-data:
  postgres_data:

networks:
  backtest-network:
    driver: bridge

